<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§’è‰²ç”»å¸ˆç®¡ç†å™¨ V3.4</title>
    <style>
        :root {
            --primary-color: #007bff; --success-color: #28a745; --danger-color: #dc3545;
            --secondary-color: #6c757d; --light-gray: #f8f9fa; --dark-gray: #343a40;
            --border-color: #dee2e6; --card-shadow: 0 1px 3px rgba(0,0,0,0.1);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --edit-mode-bg: #e6f4ea;
            --role-main-gradient: linear-gradient(to left, #f7ba2b 0%, #ea5358 100%);
            --role-supporting-color: #f7ba2b;
        }
        * { box-sizing: border-box; }
        body {
            font-family: var(--font-family); margin: 0; background-color: #f0f2f5;
            color: var(--dark-gray); line-height: 1.5; display: flex;
            flex-direction: column; height: 100vh; overflow: hidden;
        }

        /* --- å¤´éƒ¨åŒºåŸŸ --- */
        .app-header {
            background-color: #fff; padding: 0.75rem 1.5rem; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); flex-shrink: 0; z-index: 100;
        }
        .header-left { display: flex; align-items: center; gap: 1.5rem; }
        .app-header h1 { margin: 0; font-size: 1.5rem; }
        .header-actions { display: flex; align-items: center; gap: 0.75rem; }
        .header-actions button {
            padding: 0.5rem 1rem; font-size: 0.9rem; cursor: pointer; border: 1px solid var(--primary-color);
            background-color: var(--primary-color); color: #fff; border-radius: 5px;
            transition: background-color 0.2s; display: flex; align-items: center; gap: 0.25rem;
        }
        .header-actions button:hover:not(:disabled) { background-color: #0056b3; }
        .header-actions button:disabled { background-color: var(--secondary-color); border-color: var(--secondary-color); cursor: not-allowed; opacity: 0.65; }
        .header-actions button.save-btn { background-color: var(--success-color); border-color: var(--success-color); }
        .header-actions button.save-btn:hover:not(:disabled) { background-color: #218838; }
        #filter-toggle-btn { background-color: transparent; border-color: var(--secondary-color); color: var(--secondary-color); }
        #filter-toggle-btn:hover { background-color: var(--secondary-color); color: #fff; }
        #filter-toggle-btn .arrow { transition: transform 0.2s; display: inline-block; }
        #filter-toggle-btn.expanded .arrow { transform: rotate(180deg); }
        .header-actions .dropdown { position: relative; }
        .header-actions .dropdown-content { display: none; position: absolute; right: 0; top: 100%; background-color: white; min-width: 160px; box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2); z-index: 1; border-radius: 5px; overflow: hidden; border: 1px solid var(--border-color); }
        .header-actions .dropdown-content button { width: 100%; background-color: white; color: black; border: none; text-align: left; border-radius: 0; border-bottom: 1px solid var(--border-color); }
        .header-actions .dropdown-content button:last-child { border-bottom: none; }
        .header-actions .dropdown-content button:hover { background-color: #f1f1f1; }
        .header-actions .dropdown:hover .dropdown-content { display: block; }
        
        /* --- é¡µç­¾å¯¼èˆªæ  --- */
        .tab-navigation button {
            padding: 0.5rem 1rem; font-size: 1rem; font-weight: 600; border: none;
            background-color: transparent; cursor: pointer; color: var(--secondary-color);
            border-radius: 5px; transition: color 0.2s, background-color 0.2s;
        }
        .tab-navigation button:hover { background-color: #e9ecef; }
        .tab-navigation button.active { color: #fff; background-color: var(--primary-color); }
        
        /* --- V3.0: ä¸‰æ å¸ƒå±€ --- */
        .main-container { display: flex; flex-grow: 1; overflow: hidden; }

        /* --- å·¦ä¾§è¾¹æ  (åˆ†ç±») --- */
        .sidebar {
            flex: 0 0 220px; background-color: #fff; border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .sidebar-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0;
        }
        .sidebar-header h2 { margin: 0; font-size: 1.2rem; }
        .icon-btn { cursor: pointer; color: var(--secondary-color); transition: color 0.2s, transform 0.2s; }
        .icon-btn:hover { color: var(--primary-color); transform: scale(1.1); }
        .category-list {
            list-style: none; padding: 1rem; margin: 0; overflow-y: auto; flex-grow: 1;
        }
        .category-list li {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1rem; margin-bottom: 0.5rem; border-radius: 5px;
            cursor: pointer; transition: background-color 0.2s, color 0.2s; font-weight: 500;
        }
        .category-list li:hover .category-edit-btn { opacity: 1; }
        .category-list li span:first-child { word-break: break-all; margin-right: 8px; flex-grow: 1; }
        .category-list li .count {
            font-size: 0.8em; color: inherit; opacity: 0.7; background-color: rgba(0,0,0,0.05);
            padding: 1px 5px; border-radius: 5px; margin-right: 8px;
        }
        .category-edit-btn { opacity: 0; transition: opacity 0.2s; }
        .category-list li:hover { background-color: #e9ecef; }
        .category-list li.active { background-color: var(--primary-color); color: #fff; }
        .category-list li.active .count { background-color: rgba(255,255,255,0.2); }
        .category-list li.active .icon-btn { color: #fff; }

        /* --- ä¸­æ å†…å®¹åŒº (å¡ç‰‡ç½‘æ ¼) --- */
        .content-area {
            flex: 1 1 auto; display: flex; flex-direction: column;
            overflow: hidden; padding: 1.5rem; min-width: 400px;
            transition: background-color 0.3s;
        }
        .content-area.edit-mode-active {
            background-color: var(--edit-mode-bg);
        }
        .filter-bar {
            display: flex; gap: 1rem; flex-shrink: 0; align-items: center; overflow: hidden;
            max-height: 0; padding-bottom: 0; margin-bottom: 0; opacity: 0;
            transition: all 0.4s ease-out;
        }
        .filter-bar.expanded { max-height: 100px; opacity: 1; padding-bottom: 1.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color);}
        .filter-bar .search-box { flex-grow: 1; }
        .filter-bar .filter-selects { display: flex; gap: 1rem; flex-basis: 40%; }
        .filter-bar input, .filter-bar select { width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 5px; font-size: 0.95rem; }

        .card-grid-container { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        .card-grid { display: grid; gap: 1rem; }
        .card-grid.text-mode { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
        .card-grid.gallery-mode { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
        
        .placeholder { grid-column: 1 / -1; display: flex; justify-content: center; align-items: center; height: 100%; color: var(--secondary-color); font-size: 1.2rem; font-style: italic; }

        .card {
            position: relative; background-color: #fff; border-radius: 6px; box-shadow: var(--card-shadow);
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
        }
        .card.selected { border-color: var(--primary-color); box-shadow: 0 0 8px rgba(0, 123, 255, 0.5); }
        
        /* --- V3.4: Role-based Card Styles --- */
        .card-role-supporting {
            border-color: var(--role-supporting-color);
        }
        .card-role-main {
            padding: 4px; border: none; border-radius: 1rem;
            background: var(--role-main-gradient);
        }
        .card-role-main:hover { transform: translateY(-3px) scale(1.02); }
        .card-role-main .card-content {
             background: #fff; border-radius: .7rem; height: 100%;
             display: flex; align-items: center; justify-content: center; flex-direction: column;
        }
        .card-role-main.gallery-card .card-content {
            background-color: transparent;
        }
        .card-role-main.gallery-card .card-image {
             border-top-left-radius: .7rem; border-top-right-radius: .7rem;
        }
        .card-role-main.gallery-card .card-name {
            background-color: #fff; width: 100%;
            border-bottom-left-radius: .7rem; border-bottom-right-radius: .7rem;
        }
        
        .card.text-card { height: 50px; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .card-name { font-weight: 600; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .card.gallery-card { display: flex; flex-direction: column; }
        .gallery-card .card-image { width: 100%; height: 200px; object-fit: cover; background-color: #eee; border-top-left-radius: 4px; border-top-right-radius: 4px; }
        .gallery-card .card-name { padding: 0.75rem; text-align: center; }

        /* --- å³ä¾§è¯¦æƒ…æ  --- */
        .detail-sidebar {
            flex: 0 0 300px; background-color: #fff; border-left: 1px solid var(--border-color);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .detail-content { padding: 1.5rem; flex-grow: 1; overflow-y: auto; }
        .detail-placeholder { display: flex; height: 100%; justify-content: center; align-items: center; color: var(--secondary-color); text-align: center; }
        .detail-image { width: 100%; height: auto; border-radius: 6px; margin-bottom: 1rem; background-color: #eee; min-height: 150px; }
        .detail-title { font-size: 1.5rem; margin: 0 0 0.5rem; }
        .detail-source { font-size: 1rem; color: var(--secondary-color); margin-bottom: 1.5rem; }
        .detail-section { margin-bottom: 1.5rem; }
        .detail-section h5 { margin: 0 0 0.5rem; font-size: 0.9rem; text-transform: uppercase; color: var(--secondary-color); }
        .detail-section p, .detail-tags { margin: 0; word-wrap: break-word; }
        .detail-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .detail-tag { background-color: #e9ecef; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem; }
        .detail-tag.role-main { background-color: #f7ba2b; color: white; font-weight: bold; }
        .detail-tag.role-supporting { background-color: var(--primary-color); color: white; }
        .detail-tag.role-passerby { background-color: #6c757d; color: white; }
        .detail-actions { display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap;}

        /* --- å¼€å…³ Toggle Switch --- */
        .toggle-switch { display: flex; align-items: center; gap: 8px; color: var(--secondary-color); font-weight: 500;}
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input#edit-mode-toggle:checked + .slider { background-color: var(--success-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- æ¨¡æ€æ¡† --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.visible { display: flex; }
        .modal-content { background-color: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 550px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-content h3 { margin-top: 0; margin-bottom: 1.5rem; }
        .modal-body { overflow-y: auto; padding-right: 1rem; margin-right: -1rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1rem; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .modal-actions { margin-top: 2rem; display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
        .modal-actions .btn-danger { background-color: var(--danger-color); color: #fff; }
        .modal-actions .btn-danger.confirming { background-color: #a71d2a; }
        .modal-actions .action-group-right { display: flex; gap: 1rem; }
        .modal-actions button, .load-confirm-modal .modal-actions button, #about-modal .modal-actions button { padding: 0.6rem 1.2rem; font-size: 1rem; border-radius: 5px; border: none; cursor: pointer; }
        .modal-actions .btn-secondary { background-color: #e9ecef; color: var(--dark-gray); }
        .modal-actions .btn-secondary:hover { background-color: #dbe1e6; }
        .modal-actions .btn-primary { background-color: var(--primary-color); color: #fff; }
        .modal-actions .btn-primary:hover { background-color: #0056b3; }
        .load-confirm-modal .modal-content { max-width: 400px; }
        .load-confirm-modal .modal-actions { justify-content: center; }
        #batch-import-modal .modal-content { max-width: 700px; }
        #batch-import-modal textarea { min-height: 30vh; font-family: monospace; }
        #import-preview-container { border: 1px solid var(--border-color); margin-top: 1rem; padding: 1rem; max-height: 40vh; overflow-y: auto; background-color: var(--light-gray); font-size: 0.9rem; }
        .preview-item { padding: 0.5rem; border-bottom: 1px dashed var(--border-color); }
        .preview-item:last-child { border-bottom: none; }
        .preview-item.status-new { color: var(--success-color); }
        .preview-item.status-skip { color: var(--secondary-color); text-decoration: line-through; }
        .preview-item.status-error { color: var(--danger-color); font-weight: bold; }
        #import-summary { margin-top: 1rem; font-weight: bold; }
        #about-modal .modal-content { max-width: 700px; }
        #about-modal .modal-actions { justify-content: flex-end; }
        #about-modal .modal-body h4 { margin-top: 1.5em; margin-bottom: 0.5em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.25em;}
        #about-modal .modal-body ul { padding-left: 20px; }
        #about-modal .modal-body p, #about-modal .modal-body li { color: #495057; }

        /* --- Category Index Modal --- */
        #category-index-modal .modal-content { max-width: 800px; }
        #category-index-modal .modal-body { padding-right: 0; margin-right: 0; }
        .index-header { position: sticky; top: -2rem; background: #fff; padding: 1rem 0; z-index: 10; display: flex; flex-direction: column; gap: 1rem; margin: -2rem -2rem 1.5rem -2rem; padding: 1rem 2rem 0 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .alphabet-nav { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; }
        .alphabet-nav a { text-decoration: none; padding: 0.25rem 0.5rem; color: var(--primary-color); font-weight: bold; border-radius: 4px; cursor: pointer;}
        .alphabet-nav a:hover { background-color: #e9ecef; }
        .index-search-box input { width: 100%; }
        .index-list-group-title { font-size: 1.2rem; font-weight: bold; padding: 0.5rem 0; margin-top: 1rem; border-bottom: 2px solid var(--primary-color); grid-column: 1 / -1; }
        .index-list { list-style: none; padding: 0; margin: 0; display: grid; grid-template-columns: 1fr 1fr; gap: 0 1.5rem; }
        .index-list li { padding: 0.5rem 0; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .index-list li:hover { color: var(--primary-color); }
        
        /* --- æç¤ºæ¡† (Toast) --- */
        .toast-notification { position: fixed; bottom: 2rem; right: 2rem; background-color: var(--success-color); color: #fff; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 3000; opacity: 0; visibility: hidden; transform: translateY(20px); transition: all 0.3s; }
        .toast-notification.show { opacity: 1; visibility: visible; transform: translateY(0); }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="header-left">
            <h1>ç®¡ç†å™¨ V3.4</h1>
            <nav class="tab-navigation">
                <button id="tab-characters" class="active">è§’è‰²</button>
                <button id="tab-artists">ç”»å¸ˆ</button>
            </nav>
        </div>
        <div class="header-actions">
            <div class="toggle-switch">
                <label for="edit-mode-toggle">ç¼–è¾‘</label>
                <label class="switch"><input type="checkbox" id="edit-mode-toggle"><span class="slider"></span></label>
            </div>
             <div class="toggle-switch">
                <label for="gallery-mode-toggle">å›¾æ–‡</label>
                <label class="switch"><input type="checkbox" id="gallery-mode-toggle" checked><span class="slider"></span></label>
            </div>
            <div class="dropdown">
                <button id="tools-btn">å·¥å…·</button>
                <div class="dropdown-content">
                    <button id="upgrade-prompt-btn">å‡çº§Promptç»“æ„</button>
                </div>
            </div>
            <button id="filter-toggle-btn">ç­›é€‰ <span class="arrow">â–¼</span></button>
            <button id="load-json-btn">åŠ è½½</button>
            <input type="file" id="file-input" accept=".json" style="display: none;">
            <button id="batch-import-btn">æ‰¹é‡å¯¼å…¥</button>
            <button id="add-item-btn">æ·»åŠ </button>
            <button id="random-select-btn">ğŸ²</button>
            <button id="about-btn">å…³äº</button>
            <button id="save-json-btn" class="save-btn">ä¿å­˜</button>
        </div>
    </header>

    <main class="main-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2 id="sidebar-title">ä½œå“åˆ†ç±»</h2>
                <span id="category-index-btn" class="icon-btn" title="åˆ†ç±»ç´¢å¼•">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                </span>
            </div>
            <ul class="category-list" id="category-list"></ul>
        </aside>

        <div class="content-area" id="content-area">
            <div class="filter-bar" id="filter-bar">
                <div class="search-box">
                    <input type="search" id="search-input" placeholder="å…¨å±€æœç´¢åç§°ã€å‡ºå¤„ã€ç®€ä»‹...">
                </div>
                <div class="filter-selects">
                    <select id="gender-filter">
                        <option value="">æ‰€æœ‰æ€§åˆ«</option><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option><option value="æ‰¶å¥¹">æ‰¶å¥¹</option><option value="æœªçŸ¥">æœªçŸ¥</option>
                    </select>
                    <select id="age-filter">
                        <option value="">æ‰€æœ‰å¹´é¾„</option><option value="å¹¼å¹´">å¹¼å¹´</option><option value="å°‘å¹´">å°‘å¹´</option><option value="é’å¹´">é’å¹´</option><option value="æˆå¹´">æˆå¹´</option>
                    </select>
                </div>
            </div>
            <div class="card-grid-container">
                <div class="card-grid" id="card-grid"></div>
            </div>
        </div>

        <aside class="detail-sidebar" id="detail-sidebar">
            <div class="detail-content" id="detail-content">
                <div class="detail-placeholder"><p>å•å‡»å¡ç‰‡æŸ¥çœ‹è¯¦æƒ…</p></div>
            </div>
        </aside>
    </main>
    
    <!-- All Modals will be injected by JS -->
    <div class="modal-overlay" id="entry-modal"></div>
    <div class="modal-overlay" id="batch-import-modal"></div>
    <div class="modal-overlay" id="load-confirm-modal"></div>
    <div class="modal-overlay" id="category-index-modal"></div>
    <div class="modal-overlay" id="category-edit-modal"></div>
    <div class="modal-overlay" id="about-modal"></div>

    <div id="toast" class="toast-notification"></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. STATE & CONFIG ---
        let appData = { characters: [], artists: [] };
        let activeView = 'characters';
        let activeCategory = 'æ€»è§ˆ';
        let isEditMode = false;
        let isGalleryMode = true;
        let currentSelectedId = null;
        let pendingFile = null;
        let toastTimer = null;
        let deleteConfirmTimer = null;
        let searchDebounceTimer = null;
        let importPreviewData = [];

        // --- 2. DOM ELEMENTS MAPPING ---
        const dom = {
            editModeToggle: document.getElementById('edit-mode-toggle'),
            galleryModeToggle: document.getElementById('gallery-mode-toggle'),
            upgradePromptBtn: document.getElementById('upgrade-prompt-btn'),
            filterToggleBtn: document.getElementById('filter-toggle-btn'),
            loadBtn: document.getElementById('load-json-btn'),
            fileInput: document.getElementById('file-input'),
            saveBtn: document.getElementById('save-json-btn'),
            addBtn: document.getElementById('add-item-btn'),
            batchImportBtn: document.getElementById('batch-import-btn'),
            randomSelectBtn: document.getElementById('random-select-btn'),
            aboutBtn: document.getElementById('about-btn'),
            tabs: { characters: document.getElementById('tab-characters'), artists: document.getElementById('tab-artists') },
            sidebarTitle: document.getElementById('sidebar-title'),
            categoryIndexBtn: document.getElementById('category-index-btn'),
            categoryList: document.getElementById('category-list'),
            contentArea: document.getElementById('content-area'),
            filterBar: document.getElementById('filter-bar'),
            searchInput: document.getElementById('search-input'),
            genderFilter: document.getElementById('gender-filter'),
            ageFilter: document.getElementById('age-filter'),
            cardGrid: document.getElementById('card-grid'),
            detailSidebar: document.getElementById('detail-sidebar'),
            detailContent: document.getElementById('detail-content'),
            toast: document.getElementById('toast'),
            entryModal: { overlay: document.getElementById('entry-modal') },
            batchModal: { overlay: document.getElementById('batch-import-modal') },
            loadConfirmModal: { overlay: document.getElementById('load-confirm-modal') },
            categoryIndexModal: { overlay: document.getElementById('category-index-modal') },
            categoryEditModal: { overlay: document.getElementById('category-edit-modal') },
            aboutModal: { overlay: document.getElementById('about-modal') }
        };

        // --- 3. INITIALIZE & TEMPLATES ---
        function initializeApp() {
            setupModalHTML();
            addEventListeners();
            render();
        }

        function setupModalHTML() {
            dom.entryModal.overlay.innerHTML = `<div class="modal-content"><h3 id="modal-title"></h3><div class="modal-body"><form id="entry-form"><input type="hidden" id="entry-id"><div class="form-group"><label for="entry-name">åç§° (ä¸­æ–‡)</label><input type="text" id="entry-name" required></div><div class="form-group"><label for="entry-source">å‡ºå¤„ (ä¸­æ–‡)</label><input type="text" id="entry-source" required></div><div class="form-group"><label for="entry-prompt-name">Prompt Name (è‹±æ–‡å)</label><input type="text" id="entry-prompt-name"></div><div class="form-group"><label for="entry-prompt-source">Prompt Source (è‹±æ–‡ä½œå“ç³»åˆ—å)</label><input type="text" id="entry-prompt-source"></div><div id="character-fields"><div class="form-group"><label for="entry-role">ä¸»æ¬¡å±æ€§</label><select id="entry-role"><option value="è·¯äºº">è·¯äºº</option><option value="é…è§’">é…è§’</option><option value="ä¸»è§’">ä¸»è§’</option></select></div><div style="display: flex; gap: 1rem;"><div class="form-group" style="flex: 1;"><label for="entry-gender">æ€§åˆ«</label><select id="entry-gender"><option value="å¥³">å¥³</option><option value="ç”·">ç”·</option><option value="æ‰¶å¥¹">æ‰¶å¥¹</option><option value="æœªçŸ¥">æœªçŸ¥</option></select></div><div class="form-group" style="flex: 1;"><label for="entry-age">å¹´é¾„æ®µ</label><select id="entry-age"><option value="é’å¹´">é’å¹´</option><option value="å°‘å¹´">å°‘å¹´</option><option value="å¹¼å¹´">å¹¼å¹´</option><option value="æˆå¹´">æˆå¹´</option></select></div><div class="form-group" style="flex: 1;"><label for="entry-mal-id">MAL ID</label><input type="number" id="entry-mal-id" placeholder="å¯é€‰"></div></div></div><div class="form-group"><label for="entry-description">ç®€ä»‹</label><textarea id="entry-description" placeholder="è§’è‰²/ç”»å¸ˆç®€ä»‹..."></textarea></div><div class="form-group"><label for="entry-image-url">åœ¨çº¿å›¾ç‰‡URL</label><input type="text" id="entry-image-url" placeholder="ä¾‹å¦‚: https://cdn.myanimelist.net/..."></div><div class="form-group"><label for="entry-image">æœ¬åœ°å›¾ç‰‡æ–‡ä»¶å</label><input type="text" id="entry-image" placeholder="ä¾‹å¦‚: ying.png (ä¼˜å…ˆäºåœ¨çº¿URL)"></div></form></div><div class="modal-actions"><button type="button" class="btn-danger" id="modal-delete-btn" style="display: none;">åˆ é™¤</button><div class="action-group-right"><button type="button" class="btn-secondary" data-action="close-modal">å–æ¶ˆ</button><button type="button" class="btn-primary" id="modal-save-btn">ä¿å­˜</button></div></div></div>`;
            dom.batchModal.overlay.innerHTML = `<div class="modal-content"><h3 id="batch-import-title">æ‰¹é‡å¯¼å…¥</h3><div class="modal-body"><div class="form-group"><label for="batch-import-text">ç²˜è´´æ¥è‡ªâ€œé‡‡é›†å™¨â€çš„æ–‡æœ¬</label><textarea id="batch-import-text" rows="10" placeholder="[START_ITEM]..."></textarea><small>æ”¯æŒV1.8+é‡‡é›†å™¨ç”Ÿæˆçš„å­—æ®µæ ‡è®°æ ¼å¼ã€‚</small></div><div id="import-preview-container" style="display:none;"></div><div id="import-summary" style="display:none;"></div></div><div class="modal-actions"><div id="batch-import-actions-initial" style="display:flex; justify-content:flex-end;"><button type="button" class="btn-secondary" data-action="close-modal">å–æ¶ˆ</button><button type="button" class="btn-primary" id="batch-import-preview-btn">é¢„è§ˆå¯¼å…¥</button></div><div id="batch-import-actions-preview" style="display:none;"><button type="button" class="btn-secondary" id="batch-import-back-btn">è¿”å›ç¼–è¾‘</button><button type="button" class="btn-primary" id="batch-import-confirm-btn">ç¡®è®¤å¯¼å…¥</button></div></div></div>`;
            dom.loadConfirmModal.overlay.innerHTML = `<div class="modal-content"><h3>é€‰æ‹©åŠ è½½æ–¹å¼</h3><p>å¦‚ä½•å¤„ç†æ–°åŠ è½½çš„æ•°æ®ï¼Ÿ</p><div class="modal-actions" style="justify-content: center;"><button type="button" class="btn-primary" id="load-action-merge">åˆå¹¶</button><button type="button" class="btn-danger" id="load-action-overwrite">è¦†ç›–</button><button type="button" class="btn-secondary" data-action="close-modal">å–æ¶ˆ</button></div></div>`;
            dom.categoryIndexModal.overlay.innerHTML = `<div class="modal-content"><div class="index-header"><div class="alphabet-nav" id="alphabet-nav"></div><div class="index-search-box"><input type="search" id="index-search-input" placeholder="å®æ—¶æœç´¢åˆ†ç±»..."></div></div><div class="modal-body"><ul id="index-list" class="index-list"></ul></div></div>`;
            dom.categoryEditModal.overlay.innerHTML = `<div class="modal-content"><h3 id="category-edit-title">ç¼–è¾‘åˆ†ç±»åç§°</h3><div class="modal-body"><form id="category-edit-form"><div class="form-group"><label for="category-edit-source">å‡ºå¤„ (ä¸­æ–‡)</label><input type="text" id="category-edit-source" required></div><div class="form-group"><label for="category-edit-prompt-source">Prompt Source (è‹±æ–‡ä½œå“ç³»åˆ—å)</label><input type="text" id="category-edit-prompt-source" required></div></form></div><div class="modal-actions"><div class="action-group-right"><button type="button" class="btn-secondary" data-action="close-modal">å–æ¶ˆ</button><button type="button" class="btn-primary" id="category-edit-save-btn">ä¿å­˜</button></div></div></div>`;
            dom.aboutModal.overlay.innerHTML = `<div class="modal-content"><h3>å…³äº è§’è‰²ç”»å¸ˆç®¡ç†å™¨ V3.4</h3><div class="modal-body"><h4>å…³äºå¼€å‘</h4><p>é¡¹ç›®ä¸­æ‰€æœ‰çš„ä»£ç å®ç°ã€é€»è¾‘ä¼˜åŒ–å’Œé—®é¢˜ä¿®å¤å·¥ä½œï¼Œå‡ç”± Google AI Studio ä¸­çš„ <strong>Gemini Pro</strong> æ¨¡å‹å®Œæˆã€‚æˆ‘æœ¬äººå¹¶ä¸ä¼šç¼–ç¨‹ç›¸å…³çš„æŠ€èƒ½ã€‚</p><p>åˆ¶ä½œç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨AIç»˜ç”»ã€‚æˆ‘ç”¨çš„NovelAIåŒ…å«å¤§é‡äºŒæ¬¡å…ƒè§’è‰²ï¼Œä½†æ˜¯å¾ˆéš¾ä»å¦‚æ­¤å¤šçš„è§’è‰²ä¸­æŒ‘é€‰è‡ªå·±æƒ³è¦çš„ã€‚å†åŠ ä¸Šè§’è‰²åæŸ¥æ‰¾ååˆ†éº»çƒ¦ï¼Œæ¯æ¬¡éœ€è¦æ‰¾ä¸€ä¼šæ‰èƒ½æ‰¾åˆ°è§’è‰²ï¼Œæ‰€ä»¥å°±æƒ³åšä¸€ä¸ªå¯ä»¥æµè§ˆè§’è‰²å¹¶ä¸”ç‚¹å‡»å°±èƒ½å¤åˆ¶åŒ…å«ä½œå“åçš„è§’è‰²æç¤ºè¯ã€‚</p><p>é¡¹ç›®ä¸»é¡µ: <a href="https://github.com/970224023/anime-character-manager" target="_blank">https://github.com/970224023/anime-character-manager</a></p><h4>ä¸»è¦åŠŸèƒ½</h4><ul><li><strong>åˆ†ç±»ç®¡ç†</strong>: æ”¯æŒå¯¹è§’è‰²å’Œç”»å¸ˆä¸¤å¤§ç±»åˆ«è¿›è¡Œæ•°æ®ç®¡ç†ã€‚</li><li><strong>å›¾æ–‡åŒè§†å›¾</strong>: å¯åœ¨æ–‡å­—åˆ—è¡¨å’Œå›¾ç‰‡ç”»å»Šæ¨¡å¼ä¹‹é—´è‡ªç”±åˆ‡æ¢ã€‚</li><li><strong>ä¾¿æ·çš„Promptå¤åˆ¶</strong>: å†æ¬¡å•å‡»å·²é€‰ä¸­çš„å¡ç‰‡ï¼Œå³å¯å¿«é€Ÿå¤åˆ¶å…¶AIç»˜ç”»æç¤ºè¯ã€‚</li><li><strong>å¼ºå¤§çš„åˆ†ç±»ç´¢å¼•</strong>: æä¾›A-Zç´¢å¼•å¼¹çª—ï¼Œæ”¯æŒä¸­è‹±æ–‡æ··åˆæ’åºã€‚</li><li><strong>å®‰å…¨ç¼–è¾‘æ¨¡å¼</strong>: å¼€å¯åç•Œé¢èƒŒæ™¯ä¼šå˜è‰²ä»¥ä½œæç¤ºã€‚</li><li><strong>çµæ´»çš„æ•°æ®æ“ä½œ</strong>: æ”¯æŒåŠ è½½ã€ä¿å­˜ã€æ‰¹é‡å¯¼å…¥ã€æ·»åŠ ã€ç¼–è¾‘å’Œåˆ é™¤æ¡ç›®ã€‚</li></ul><h4>å¦‚ä½•ä½¿ç”¨</h4><ol><li><strong>åŠ è½½æ•°æ®</strong>: é¦–æ¬¡ä½¿ç”¨ï¼Œéœ€è¦ä¸€ä¸ª <code>manager_data.json</code> æ–‡ä»¶ã€‚ç‚¹å‡»å³ä¸Šè§’çš„ã€åŠ è½½ã€‘æŒ‰é’®è¿›è¡Œé€‰æ‹©ã€‚</li><li><strong>æµè§ˆä¸æ“ä½œ</strong>: åœ¨å·¦ä¾§é€‰æ‹©åˆ†ç±»ï¼Œåœ¨ä¸­æ æµè§ˆå¡ç‰‡ã€‚å•å‡»å¡ç‰‡æŸ¥çœ‹è¯¦æƒ…ï¼Œå†æ¬¡å•å‡»å¤åˆ¶æç¤ºè¯ã€‚</li><li><strong>ä¿å­˜æ•°æ®</strong>: æ‰€æœ‰æ›´æ”¹å®Œæˆåï¼Œè¯·åŠ¡å¿…ç‚¹å‡»å³ä¸Šè§’çš„ã€ä¿å­˜ã€‘æŒ‰é’®ï¼Œä¸‹è½½æ–°çš„æ•°æ®æ–‡ä»¶ã€‚</li></ol><h4>è‡´è°¢</h4><p>æ•°æ®æ¥æºäº <a href="https://myanimelist.net/" target="_blank">MyAnimeList (MAL)</a>ï¼Œé€šè¿‡ä¼˜ç§€çš„ç¤¾åŒºé¡¹ç›® <a href="https://jikan.moe/" target="_blank">Jikan API</a> è·å–ã€‚è¯·å°Šé‡å¹¶åˆç†ä½¿ç”¨ä»¥ä¸ŠæœåŠ¡ã€‚</p></div><div class="modal-actions"><button type="button" class="btn-primary" data-action="close-modal">å…³é—­</button></div></div>`;
        }

        function addEventListeners() {
            dom.editModeToggle.addEventListener('change', (e) => { 
                isEditMode = e.target.checked; 
                dom.contentArea.classList.toggle('edit-mode-active', isEditMode);
            });
            dom.galleryModeToggle.addEventListener('change', (e) => { isGalleryMode = e.target.checked; renderCards(); });
            dom.upgradePromptBtn.addEventListener('click', upgradePromptStructure);
            dom.filterToggleBtn.addEventListener('click', (e) => {
                dom.filterBar.classList.toggle('expanded');
                e.currentTarget.classList.toggle('expanded');
            });
            dom.loadBtn.addEventListener('click', () => dom.fileInput.click());
            dom.fileInput.addEventListener('change', handleFileSelect);
            dom.saveBtn.addEventListener('click', handleSaveData);
            dom.addBtn.addEventListener('click', () => openModal('add'));
            dom.batchImportBtn.addEventListener('click', openBatchImportModal);
            dom.randomSelectBtn.addEventListener('click', handleRandomSelect);
            dom.aboutBtn.addEventListener('click', () => dom.aboutModal.overlay.classList.add('visible'));
            Object.values(dom.tabs).forEach(tab => tab.addEventListener('click', handleTabClick));
            dom.categoryList.addEventListener('click', handleCategoryClick);
            dom.cardGrid.addEventListener('click', handleCardClick);
            dom.detailContent.addEventListener('click', handleDetailViewClick);
            dom.categoryIndexBtn.addEventListener('click', openCategoryIndexModal);
            dom.searchInput.addEventListener('input', () => debounceRender(300));
            dom.genderFilter.addEventListener('change', renderCards);
            dom.ageFilter.addEventListener('change', renderCards);
            
            document.addEventListener('click', (e) => {
                const target = e.target;
                if(target.dataset.action === 'close-modal') { closeModal(); return; }
                const targetId = target.id;
                if (targetId === 'modal-save-btn') handleFormSave();
                if (targetId === 'modal-delete-btn') handleDeleteClick();
                if (targetId === 'load-action-merge') processFileLoad('merge');
                if (targetId === 'load-action-overwrite') processFileLoad('overwrite');
                if (targetId === 'batch-import-preview-btn') handleImportPreview();
                if (targetId === 'batch-import-back-btn') showImportStep('initial');
                if (targetId === 'batch-import-confirm-btn') handleImportConfirm();
                if(target.classList.contains('modal-overlay')) closeModal();
            });
        }
        
        // --- 4. CORE FUNCTIONS ---
        function render() {
            renderCategories();
            renderCards();
            renderDetailView(findItemById(currentSelectedId));
        }

        function debounceRender(delay) {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(renderCards, delay);
        }
        
        function findItemById(id) {
            if (!id) return null;
            return appData[activeView].find(item => item.id === id);
        }

        function renderCategories() {
            const currentData = appData[activeView] || [];
            const categoryCounts = currentData.reduce((acc, item) => {
                const source = item.source || 'æœªåˆ†ç±»';
                acc[source] = (acc[source] || 0) + 1;
                return acc;
            }, {});
            const categories = ['æ€»è§ˆ', ...Object.keys(categoryCounts)].sort((a, b) => {
                if (a === 'æ€»è§ˆ') return -1; if (b === 'æ€»è§ˆ') return 1;
                return a.localeCompare(b, 'zh-CN');
            });
            dom.categoryList.innerHTML = categories.map(cat => {
                const count = cat === 'æ€»è§ˆ' ? currentData.length : categoryCounts[cat];
                return `<li class="${cat === activeCategory ? 'active' : ''}" data-category="${cat}">
                    <span>${cat}</span>
                    <span class="count">${count}</span>
                    ${cat !== 'æ€»è§ˆ' ? `<span class="icon-btn category-edit-btn" title="ç¼–è¾‘åˆ†ç±»å" data-action="edit-category" data-category-name="${cat}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></span>` : ''}
                </li>`;
            }).join('');
        }
        
        function renderCards() {
            const dataToRender = getFilteredData();
            const isGallery = isGalleryMode && activeCategory !== 'æ€»è§ˆ';
            
            dom.cardGrid.className = 'card-grid';
            dom.cardGrid.classList.add(isGallery ? 'gallery-mode' : 'text-mode');
            
            if (dataToRender.length === 0) {
                dom.cardGrid.innerHTML = `<div class="placeholder">${appData[activeView].length > 0 ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ¡ç›®ã€‚' : 'è¯·å…ˆåŠ è½½æ•°æ®ã€‚'}</div>`;
                return;
            }

            dom.cardGrid.innerHTML = dataToRender.map(item => {
                const isSelected = item.id === currentSelectedId;
                const roleClass = { 'ä¸»è§’': 'card-role-main', 'é…è§’': 'card-role-supporting' }[item.role] || '';
                
                let cardHTML = '';
                if (isGallery && (item.image || item.imageUrl)) {
                    let imagePath = '';
                    if (item.image) imagePath = `images/${item.source}/${item.image}`;
                    else if (item.imageUrl) imagePath = item.imageUrl;
                    
                    cardHTML = `
                        <img class="card-image" src="${imagePath}" loading="lazy" onerror="this.style.backgroundColor='#f0f0f0'; this.removeAttribute('src');">
                        <div class="card-name">${item.name}</div>
                    `;
                } else {
                    cardHTML = `<div class="card-name">${item.name}</div>`;
                }

                if (roleClass === 'card-role-main') {
                    return `<div class="card gallery-card ${roleClass} ${isSelected ? 'selected' : ''}" data-id="${item.id}">
                                <div class="card-content">${cardHTML}</div>
                            </div>`;
                } else {
                    return `<div class="card ${isGallery ? 'gallery-card' : 'text-card'} ${roleClass} ${isSelected ? 'selected' : ''}" data-id="${item.id}">
                                ${cardHTML}
                            </div>`;
                }
            }).join('');
        }

        function renderDetailView(item) {
            if (!item) {
                dom.detailContent.innerHTML = `<div class="detail-placeholder"><p>å•å‡»å¡ç‰‡æŸ¥çœ‹è¯¦æƒ…</p></div>`;
                return;
            }

            let imagePath = '';
            if (item.image) { imagePath = `images/${item.source}/${item.image}`; }
            else if (item.imageUrl) { imagePath = item.imageUrl; }
            
            const fullPrompt = (item.prompt_name || item.prompt_source) ? `${item.prompt_name} (${item.prompt_source})` : item.prompt;

            let tagsHtml = '';
            if (activeView === 'characters') {
                const roleClassMap = { 'ä¸»è§’': 'role-main', 'é…è§’': 'role-supporting', 'è·¯äºº': 'role-passerby' };
                const roleClass = roleClassMap[item.role] || '';
                tagsHtml += `<div class="detail-tag ${roleClass}">${item.role || 'è·¯äºº'}</div>`;
                tagsHtml += `<div class="detail-tag">${item.gender || ''}</div><div class="detail-tag">${item.age || ''}</div>`;
                if (item.mal_id) tagsHtml += `<div class="detail-tag">MAL ID: ${item.mal_id}</div>`;
            }

            dom.detailContent.innerHTML = `
                <img src="${imagePath}" class="detail-image" onerror="this.style.visibility='hidden'">
                <h3 class="detail-title">${item.name}</h3>
                <p class="detail-source">${item.source}</p>
                <div class="detail-section"><h5>ç®€ä»‹</h5><p>${item.description ? item.description.replace(/\n/g, '<br>') : 'æ— '}</p></div>
                <div class="detail-section"><h5>æ ‡ç­¾</h5><div class="detail-tags">${tagsHtml}</div></div>
                <div class="detail-section"><h5>æç¤ºè¯ (Prompt)</h5><p>${fullPrompt || 'N/A'}</p></div>
                <div class="detail-actions">
                    <button class="btn btn-primary" data-action="copy-prompt">å¤åˆ¶Prompt</button>
                    <button class="btn btn-secondary" data-action="swap-name" title="è°ƒæ¢Promptä¸­çš„å§“ä¸å">è°ƒæ¢</button>
                    <button class="btn btn-secondary" data-action="edit-item">ç¼–è¾‘</button>
                </div>`;
        }
        
        function getFilteredData() {
            let currentData = appData[activeView] || [];
            if (activeCategory !== 'æ€»è§ˆ') {
                currentData = currentData.filter(item => (item.source || 'æœªåˆ†ç±»') === activeCategory);
            }

            const searchTerm = dom.searchInput.value.toLowerCase().trim();
            if (searchTerm) {
                currentData = currentData.filter(item => 
                    item.name?.toLowerCase().includes(searchTerm) ||
                    item.source?.toLowerCase().includes(searchTerm) ||
                    item.description?.toLowerCase().includes(searchTerm) ||
                    item.prompt_name?.toLowerCase().includes(searchTerm) ||
                    item.prompt_source?.toLowerCase().includes(searchTerm)
                );
            }
            if(activeView === 'characters') {
                const gender = dom.genderFilter.value;
                if (gender) currentData = currentData.filter(item => item.gender === gender);
                const age = dom.ageFilter.value;
                if (age) currentData = currentData.filter(item => item.age === age);
            }

            // Role-based sorting
            const rolePriority = { 'ä¸»è§’': 1, 'é…è§’': 2, 'è·¯äºº': 3 };
            currentData.sort((a, b) => {
                const priorityA = rolePriority[a.role] || 3;
                const priorityB = rolePriority[b.role] || 3;
                if (priorityA !== priorityB) {
                    return priorityA - priorityB;
                }
                return a.name.localeCompare(b.name, 'zh-CN');
            });

            return currentData;
        }
        
        function migrateDataItem(item) {
            if (item.id === undefined) item.id = `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            if (item.mal_id === undefined) item.mal_id = null;
            if (item.imageUrl === undefined) item.imageUrl = '';
            if (item.description === undefined) item.description = '';
            if (item.prompt_name === undefined) item.prompt_name = '';
            if (item.prompt_source === undefined) item.prompt_source = '';
            if (item.prompt === undefined) item.prompt = '';
            if (activeView === 'characters' || item.gender || item.age || item.role) { // more robust check for characters
                if (item.gender === undefined) item.gender = 'å¥³';
                if (item.age === undefined) item.age = 'é’å¹´';
                if (item.role === undefined) item.role = 'è·¯äºº';
            }
            return item;
        }

        // ... [The rest of the JS code from V3.3 is largely the same]
        // ... [It includes: migrateData, handleFileSelect, processFileLoad, handleTabClick, handleCategoryClick]
        // ... [handleCardClick, handleRandomSelect, handleSaveData, all modal functions, etc.]
        // ... [I will only include the modified or new functions here to save space]
        
        function handleDetailViewClick(e) {
            const action = e.target.dataset.action; if (!action || !currentSelectedId) return;
            const item = findItemById(currentSelectedId); if (!item) return;
            
            if (action === 'copy-prompt') {
                const fullPrompt = (item.prompt_name || item.prompt_source) ? `${item.prompt_name} (${item.prompt_source})` : item.prompt;
                if (fullPrompt) navigator.clipboard.writeText(fullPrompt).then(() => showToast(`å·²å¤åˆ¶: ${fullPrompt}`));
            } else if (action === 'edit-item') {
                openModal('edit', item.id);
            } else if (action === 'swap-name') {
                handleSwapName(item);
            }
        }
        
        function handleSwapName(item) {
            if (!item.prompt_name) {
                showToast('æ²¡æœ‰å¯ä¾›è°ƒæ¢çš„Promptåç§°ã€‚', 'error');
                return;
            }
            const nameParts = item.prompt_name.trim().split(/\s+/);
            if (nameParts.length === 2) {
                const swappedName = `${nameParts[1]} ${nameParts[0]}`;
                item.prompt_name = swappedName;
                item.prompt = `${swappedName} (${item.prompt_source})`;
                renderDetailView(item); // Re-render detail view immediately
                showToast(`å§“åå·²è°ƒæ¢: ${swappedName}`, 'success');
            } else {
                showToast('åªæœ‰ä¸¤ä¸ªå•è¯ç»„æˆçš„åç§°æ‰èƒ½è°ƒæ¢ã€‚', 'error');
            }
        }

        function openModal(mode, id = null) {
            // ... (code is the same as V3.3 until filling the form)
            const modal = dom.entryModal.overlay;
            modal.classList.add('visible');
            const form = modal.querySelector('form'); form.reset();
            const deleteBtn = modal.querySelector('#modal-delete-btn');
            deleteBtn.style.display = 'none';
            deleteBtn.dataset.confirming = ''; deleteBtn.textContent = 'åˆ é™¤'; deleteBtn.classList.remove('confirming');
            const isArtistView = activeView === 'artists';
            modal.querySelector('#character-fields').style.display = isArtistView ? 'none' : 'block';
            if (mode === 'edit') {
                currentSelectedId = id;
                const item = findItemById(id); if (!item) return;
                modal.querySelector('#modal-title').textContent = `ç¼–è¾‘${isArtistView ? 'ç”»å¸ˆ' : 'æ¡ç›®'}`;
                modal.querySelector('#entry-id').value = item.id;
                modal.querySelector('#entry-name').value = item.name;
                modal.querySelector('#entry-source').value = item.source;
                modal.querySelector('#entry-prompt-name').value = item.prompt_name || '';
                modal.querySelector('#entry-prompt-source').value = item.prompt_source || '';
                modal.querySelector('#entry-description').value = item.description || '';
                modal.querySelector('#entry-image-url').value = item.imageUrl || '';
                modal.querySelector('#entry-image').value = item.image || '';
                if(!isArtistView) {
                    modal.querySelector('#entry-gender').value = item.gender || 'å¥³';
                    modal.querySelector('#entry-age').value = item.age || 'é’å¹´';
                    modal.querySelector('#entry-mal-id').value = item.mal_id || '';
                    modal.querySelector('#entry-role').value = item.role || 'è·¯äºº'; // [NEW]
                }
                deleteBtn.style.display = 'block';
            } else {
                currentSelectedId = null;
                modal.querySelector('#modal-title').textContent = `æ·»åŠ æ–°${isArtistView ? 'ç”»å¸ˆ' : 'è§’è‰²'}`;
                modal.querySelector('#entry-id').value = `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            }
        }

        function handleFormSave() {
            // ... (code is the same as V3.3 until building newItemData)
            const modal = dom.entryModal.overlay;
            const id = modal.querySelector('#entry-id').value;
            let newItemData = {
                id,
                name: modal.querySelector('#entry-name').value.trim(),
                source: modal.querySelector('#entry-source').value.trim(),
                prompt_name: modal.querySelector('#entry-prompt-name').value.trim(),
                prompt_source: modal.querySelector('#entry-prompt-source').value.trim(),
                description: modal.querySelector('#entry-description').value.trim(),
                imageUrl: modal.querySelector('#entry-image-url').value.trim(),
                image: modal.querySelector('#entry-image').value.trim()
            };
            if(activeView === 'characters'){
                newItemData.gender = modal.querySelector('#entry-gender').value;
                newItemData.age = modal.querySelector('#entry-age').value;
                newItemData.mal_id = parseInt(modal.querySelector('#entry-mal-id').value) || null;
                newItemData.role = modal.querySelector('#entry-role').value; // [NEW]
            }
            if (!newItemData.name || !newItemData.source) { alert('åç§°å’Œå‡ºå¤„ä¸èƒ½ä¸ºç©ºï¼'); return; }
            const existingItem = findItemById(id);
            if (existingItem) {
                const index = appData[activeView].findIndex(i => i.id === id);
                if (index > -1) appData[activeView][index] = { ...appData[activeView][index], ...newItemData };
            } else {
                appData[activeView].push(migrateDataItem(newItemData));
            }
            closeModal(); 
            activeCategory = newItemData.source;
            currentSelectedId = id;
            render(); 
            showToast('ä¿å­˜æˆåŠŸï¼');
        }
        
        // --- [Copying the rest of V3.3 JS from here] ---
        function migrateData(data) {
            data.characters = (data.characters || []).map(item => migrateDataItem(item, 'characters'));
            data.artists = (data.artists || []).map(item => migrateDataItem(item, 'artists'));
            return data;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0]; if (!file) return;
            pendingFile = file;
            dom.loadConfirmModal.overlay.classList.add('visible');
            event.target.value = '';
        }

        function processFileLoad(mode) {
            if (!pendingFile) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    let newData = JSON.parse(e.target.result);
                    newData = migrateData(newData);
                    if (mode === 'overwrite') {
                        appData = newData;
                        showToast('æ•°æ®å·²è¦†ç›–åŠ è½½ï¼');
                    } else if (mode === 'merge') {
                        const merge = (existing, toMerge) => {
                            const existingIds = new Set(existing.map(item => item.mal_id).filter(id => id));
                            let addedCount = 0;
                            toMerge.forEach(newItem => {
                                if (newItem.mal_id && existingIds.has(newItem.mal_id)) {} else {
                                    existing.push(newItem);
                                    addedCount++;
                                }
                            });
                            return { data: existing, added: addedCount };
                        };
                        const mergedChars = merge(appData.characters, newData.characters);
                        const mergedArtists = merge(appData.artists, newData.artists);
                        appData.characters = mergedChars.data;
                        appData.artists = mergedArtists.data;
                        showToast(`åˆå¹¶å®Œæˆï¼æ–°å¢ ${mergedChars.added} è§’è‰², ${mergedArtists.added} ç”»å¸ˆã€‚`);
                    }
                    activeCategory = 'æ€»è§ˆ';
                    currentSelectedId = null;
                    render();
                } catch (error) {
                    alert(`åŠ è½½å¤±è´¥: ${error.message}`);
                } finally {
                    closeModal();
                    pendingFile = null;
                }
            };
            reader.readAsText(pendingFile);
        }
        
        function handleTabClick(e) {
            const targetView = e.target.id.split('-')[1];
            if (targetView && targetView !== activeView) {
                activeView = targetView;
                Object.values(dom.tabs).forEach(tab => tab.classList.remove('active'));
                e.target.classList.add('active');
                dom.sidebarTitle.textContent = activeView === 'characters' ? 'ä½œå“åˆ†ç±»' : 'ç”»å¸ˆåˆ†ç±»';
                const isCharView = activeView === 'characters';
                dom.genderFilter.style.display = isCharView ? '' : 'none';
                dom.ageFilter.style.display = isCharView ? '' : 'none';
                activeCategory = 'æ€»è§ˆ';
                render();
            }
        }
        
        function handleCategoryClick(e) {
            const li = e.target.closest('li');
            if (!li) return;
            if(e.target.closest('[data-action="edit-category"]')) {
                e.stopPropagation();
                openCategoryEditModal(e.target.closest('[data-action="edit-category"]').dataset.categoryName);
                return;
            }
            const newCategory = li.dataset.category;
            if (newCategory === activeCategory) return;
            const currentActive = dom.categoryList.querySelector('li.active');
            if (currentActive) currentActive.classList.remove('active');
            li.classList.add('active');
            activeCategory = newCategory;
            currentSelectedId = null;
            renderCards();
            renderDetailView(null);
        }

        function handleCardClick(e) {
            const card = e.target.closest('.card'); if (!card) return;
            const id = card.dataset.id;
            
            if (isEditMode) { 
                openModal('edit', id); 
                return; 
            }

            const item = findItemById(id);
            if (!item) return;

            if (id === currentSelectedId) {
                const fullPrompt = (item.prompt_name || item.prompt_source) ? `${item.prompt_name} (${item.prompt_source})` : item.prompt;
                if (fullPrompt) navigator.clipboard.writeText(fullPrompt).then(() => showToast(`å·²å¤åˆ¶: ${fullPrompt}`));
                return;
            }

            currentSelectedId = id;
            const currentlySelected = dom.cardGrid.querySelector('.card.selected');
            if (currentlySelected) currentlySelected.classList.remove('selected');
            card.classList.add('selected');
            renderDetailView(item);
        }
        
        function handleRandomSelect() {
            const items = getFilteredData();
            if (items.length === 0) { showToast("æ²¡æœ‰å¯ä¾›éšæœºçš„æ¡ç›®"); return; }
            const randomItem = items[Math.floor(Math.random() * items.length)];
            currentSelectedId = randomItem.id;
            renderCards();
            const cardElement = dom.cardGrid.querySelector(`.card[data-id="${randomItem.id}"]`);
            if (cardElement) cardElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            renderDetailView(randomItem);
        }

        function handleSaveData() {
            if (appData.characters.length === 0 && appData.artists.length === 0) { showToast('æ²¡æœ‰æ•°æ®å¯ä¿å­˜ã€‚'); return; }
            const dataString = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'manager_data.json'; a.click();
            URL.revokeObjectURL(url); showToast('æ•°æ®å·²ä¿å­˜ï¼');
        }

        function closeModal() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('visible')); }
        
        function handleDeleteClick() {
            const btn = dom.entryModal.overlay.querySelector('#modal-delete-btn');
            if (btn.dataset.confirming) {
                if (currentSelectedId) {
                    appData[activeView] = appData[activeView].filter(item => item.id !== currentSelectedId);
                    currentSelectedId = null;
                    closeModal(); render(); showToast('åˆ é™¤æˆåŠŸï¼');
                }
            } else {
                btn.dataset.confirming = 'true';
                btn.textContent = 'ç¡®è®¤åˆ é™¤ï¼Ÿ';
                btn.classList.add('confirming');
                deleteConfirmTimer = setTimeout(() => { btn.dataset.confirming = ''; btn.textContent = 'åˆ é™¤'; btn.classList.remove('confirming'); }, 3000);
            }
        }

        function openBatchImportModal() {
            const modal = dom.batchModal.overlay;
            modal.querySelector('#batch-import-title').textContent = `æ‰¹é‡å¯¼å…¥åˆ° "${activeView === 'artists' ? 'ç”»å¸ˆ' : 'è§’è‰²'}"`;
            modal.querySelector('#batch-import-text').value = '';
            showImportStep('initial'); 
            modal.classList.add('visible');
        }

        function showImportStep(step) {
            const modal = dom.batchModal.overlay;
            modal.querySelector('#batch-import-actions-initial').style.display = (step === 'initial') ? 'flex' : 'none';
            modal.querySelector('#batch-import-actions-preview').style.display = (step === 'preview') ? 'flex' : 'none';
            modal.querySelector('#import-preview-container').style.display = (step === 'preview') ? 'block' : 'none';
            modal.querySelector('#import-summary').style.display = (step === 'preview') ? 'block' : 'none';
        }

        function handleImportPreview() {
            const modal = dom.batchModal.overlay;
            const text = modal.querySelector('#batch-import-text').value.trim();
            if (!text) { alert('è¯·ç²˜è´´éœ€è¦å¯¼å…¥çš„æ•°æ®ã€‚'); return; }

            importPreviewData = [];
            const items = text.split('[START_ITEM]').filter(s => s.trim());
            const existingIds = new Set(appData[activeView].map(item => item.mal_id).filter(id => id));
            let newCount = 0, skipCount = 0, errorCount = 0;
            const previewContainer = modal.querySelector('#import-preview-container');
            previewContainer.innerHTML = '';

            for (const itemText of items) {
                const newItem = {};
                const lines = itemText.trim().split('\n');
                let descriptionMode = false;
                let descriptionLines = [];

                for (const line of lines) {
                    if (line.trim() === '[END_ITEM]') {
                        descriptionMode = false;
                        newItem.description = descriptionLines.join('\n').trim();
                        break;
                    }
                    if (descriptionMode) {
                        descriptionLines.push(line);
                    } else {
                        const parts = line.split('::');
                        const key = parts[0].trim();
                        const value = parts.slice(1).join('::').trim();
                        if (key === 'description') {
                            descriptionMode = true;
                            if(value) descriptionLines.push(value);
                        } else if (key) {
                            newItem[key] = value;
                        }
                    }
                }
                if(descriptionMode) newItem.description = descriptionLines.join('\n').trim();

                if (!newItem.name || !newItem.source) {
                    errorCount++;
                    previewContainer.innerHTML += `<div class="preview-item status-error">æ ¼å¼é”™è¯¯ (ç¼ºå°‘nameæˆ–source): ${itemText.substring(0, 50)}...</div>`;
                    continue;
                }
                newItem.mal_id = parseInt(newItem.mal_id) || null;
                const fullPrompt = `${newItem.prompt_name} (${newItem.prompt_source})`;
                newItem.prompt = fullPrompt;

                if (newItem.mal_id && existingIds.has(newItem.mal_id)) {
                    skipCount++;
                    previewContainer.innerHTML += `<div class="preview-item status-skip">è·³è¿‡ (MAL IDå·²å­˜åœ¨): ${newItem.name}</div>`;
                    importPreviewData.push({ status: 'skip', data: newItem });
                } else {
                    newCount++;
                    previewContainer.innerHTML += `<div class="preview-item status-new">æ–°å¢: ${newItem.name} (${newItem.source})</div>`;
                    importPreviewData.push({ status: 'new', data: newItem });
                }
            }
            modal.querySelector('#import-summary').textContent = `é¢„è§ˆç»“æœ: æ–°å¢ ${newCount} é¡¹, è·³è¿‡ ${skipCount} é¡¹, é”™è¯¯ ${errorCount} é¡¹ã€‚`;
            modal.querySelector('#batch-import-confirm-btn').disabled = newCount === 0;
            showImportStep('preview');
        }
        
        function handleImportConfirm() {
            const newItems = importPreviewData.filter(p => p.status === 'new').map(p => migrateDataItem(p.data));
            if (newItems.length > 0) {
                appData[activeView].push(...newItems);
                render();
                showToast(`æˆåŠŸå¯¼å…¥ ${newItems.length} ä¸ªæ–°æ¡ç›®ï¼`);
            }
            closeModal();
        }
        
        function openCategoryEditModal(oldSourceName) {
            const modal = dom.categoryEditModal.overlay;
            const form = modal.querySelector('#category-edit-form');
            form.reset();
            const firstItem = appData[activeView].find(item => item.source === oldSourceName);
            const oldPromptSource = firstItem ? firstItem.prompt_source : '';
            
            modal.querySelector('#category-edit-source').value = oldSourceName;
            modal.querySelector('#category-edit-prompt-source').value = oldPromptSource;

            modal.querySelector('#category-edit-save-btn').onclick = () => {
                const newSourceName = modal.querySelector('#category-edit-source').value.trim();
                const newPromptSourceName = modal.querySelector('#category-edit-prompt-source').value.trim();
                if (!newSourceName || !newPromptSourceName) {
                    alert("åç§°ä¸èƒ½ä¸ºç©ºï¼");
                    return;
                }
                handleCategoryEdit(oldSourceName, newSourceName, newPromptSourceName);
                closeModal();
            };
            modal.classList.add('visible');
        }

        function handleCategoryEdit(oldName, newSourceName, newPromptSourceName) {
            let changedCount = 0;
            appData[activeView].forEach(item => {
                if (item.source === oldName) {
                    item.source = newSourceName;
                    item.prompt_source = newPromptSourceName;
                    changedCount++;
                }
            });
            
            if (changedCount > 0) {
                activeCategory = newSourceName;
                render();
                showToast(`åˆ†ç±»å·²é‡å‘½åï¼Œå½±å“äº† ${changedCount} ä¸ªæ¡ç›®ã€‚`);
            }
        }
        
        function upgradePromptStructure() {
            if (!confirm("æ­¤æ“ä½œå°†å°è¯•æŠŠæ—§çš„å•ä¸€Promptå­—æ®µåˆ†ç¦»ä¸ºâ€œåç§°â€å’Œâ€œä½œå“â€ä¸¤éƒ¨åˆ†ï¼Œå¹¶ä¼šè¦†ç›–å·²æœ‰çš„æ–°å­—æ®µã€‚æ­¤æ“ä½œä¸å¯é€†ï¼Œå»ºè®®å…ˆå¤‡ä»½æ•°æ®ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ")) return;
            let upgradedCount = 0;
            appData[activeView].forEach(item => {
                if (item.prompt && (!item.prompt_name || !item.prompt_source)) {
                    const match = item.prompt.match(/^(.*?)\s*\((.*?)\)$/);
                    if (match) {
                        item.prompt_name = match[1].trim();
                        item.prompt_source = match[2].trim();
                        item.prompt = ''; // Clear legacy field
                        upgradedCount++;
                    }
                }
            });
            render();
            showToast(`Promptç»“æ„å‡çº§å®Œæˆï¼å…±å¤„ç†äº† ${upgradedCount} ä¸ªæ¡ç›®ã€‚è¯·æ£€æŸ¥æ•°æ®å¹¶ä¿å­˜ã€‚`);
        }
        
        function openCategoryIndexModal() {
            const modal = dom.categoryIndexModal.overlay;
            
            const pinyinBoundaries = {
                'A': 'å•Š', 'B': 'èŠ­', 'C': 'æ“¦', 'D': 'æ­', 'E': 'å¦¸', 'F': 'å‘', 'G': 'æ—®',
                'H': 'å“ˆ', 'J': 'å‡»', 'K': 'å’–', 'L': 'åƒ', 'M': 'å¦ˆ', 'N': 'é‚£', 'O': 'å™¢',
                'P': 'è‘©', 'Q': 'å¦»', 'R': 'ç„¶', 'S': 'ä»¨', 'T': 'ä»–', 'W': 'è›™', 'X': 'å¤•',
                'Y': 'å‹', 'Z': 'åŒ'
            };
            const alphabetOrder = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
            const boundaryOrder = "ZYXWVUTSRQPONMLKJHGFEDCBA".split('');

            const getGroupKey = (source) => {
                if (!source || source.length === 0) return '#';
                const firstChar = source.charAt(0);
                if (/[a-zA-Z]/.test(firstChar)) {
                    return firstChar.toUpperCase();
                }
                for (const char of boundaryOrder) {
                    if (pinyinBoundaries[char] && source.localeCompare(pinyinBoundaries[char], 'zh-CN') >= 0) {
                        return char;
                    }
                }
                return '#';
            };

            const uniqueSources = [...new Set(appData[activeView].map(item => item.source || 'æœªåˆ†ç±»'))];
            const groupedCategories = {};

            uniqueSources.forEach(source => {
                const key = getGroupKey(source);
                if (!groupedCategories[key]) {
                    groupedCategories[key] = [];
                }
                groupedCategories[key].push(source);
            });

            const groupOrder = ['#', ...alphabetOrder];
            let listHtml = '';
            
            const isEnglish = (str) => /^[a-zA-Z]/.test(str);

            groupOrder.forEach(groupKey => {
                const items = groupedCategories[groupKey];
                if (items && items.length > 0) {
                    items.sort((a, b) => {
                        const aIsEnglish = isEnglish(a);
                        const bIsEnglish = isEnglish(b);
                        if (aIsEnglish && !bIsEnglish) return 1;
                        if (!aIsEnglish && bIsEnglish) return -1;
                        return a.localeCompare(b, 'zh-CN');
                    });

                    listHtml += `<h4 class="index-list-group-title" id="index-${groupKey}">${groupKey}</h4>`;
                    items.forEach(source => {
                        listHtml += `<li data-category-name="${source}">${source}</li>`;
                    });
                }
            });

            const listEl = modal.querySelector('#index-list');
            listEl.innerHTML = listHtml || '<div class="placeholder">æ²¡æœ‰åˆ†ç±»</div>';

            const navEl = modal.querySelector('#alphabet-nav');
            navEl.innerHTML = groupOrder.map(char => `<a data-anchor="#index-${char}">${char}</a>`).join('');
            
            navEl.onclick = (e) => {
                e.preventDefault();
                const anchor = e.target.dataset.anchor;
                if (anchor) modal.querySelector(anchor)?.scrollIntoView({ behavior: 'smooth' });
            };
            
            listEl.onclick = (e) => {
                if (e.target.tagName === 'LI') {
                    const categoryName = e.target.dataset.categoryName;
                    const liInSidebar = dom.categoryList.querySelector(`li[data-category="${categoryName}"]`);
                    if (liInSidebar) {
                       liInSidebar.click();
                       liInSidebar.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    closeModal();
                }
            };
            
            const searchInput = modal.querySelector('#index-search-input');
            searchInput.value = '';
            searchInput.oninput = () => {
                const searchTerm = searchInput.value.toLowerCase();
                listEl.querySelectorAll('li').forEach(li => {
                    li.style.display = li.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
                });
                listEl.querySelectorAll('h4').forEach(h4 => {
                    let nextEl = h4.nextElementSibling;
                    let hasVisibleLi = false;
                    while(nextEl && nextEl.tagName !== 'H4'){
                        if(nextEl.style.display !== 'none'){ hasVisibleLi = true; break; }
                        nextEl = nextEl.nextElementSibling;
                    }
                    h4.style.display = hasVisibleLi ? '' : 'none';
                });
            };
            modal.classList.add('visible');
        }

        function showToast(message, type = 'success') {
            clearTimeout(toastTimer);
            const toast = dom.toast;
            toast.textContent = message;
            toast.style.backgroundColor = type === 'success' ? 'var(--success-color)' : 'var(--danger-color)';
            toast.classList.add('show');
            toastTimer = setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // --- INITIALIZATION ---
        initializeApp();
    });
    </script>
</body>
</html>
